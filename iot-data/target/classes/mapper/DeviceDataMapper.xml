<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 对应接口：com.example.user.mapper.DeviceDataMapper -->
<mapper namespace="com.example.data.mapper.DeviceDataMapper">

    <!-- 设备数据上报 -->
    <insert id="insert" parameterType="com.example.data.pojo.DeviceData" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_device_data (device_id, value, create_time, temp, humi, battery)
        VALUES (#{deviceId}, #{value}, NOW(), #{temp}, #{humi}, #{battery})
    </insert>

    <!-- 根据设备 ID 查询历史数据 -->
    <select id="selecthistoryByDeviceId"
            parameterType="long"
            resultType="com.example.data.pojo.DeviceData">
        SELECT
        id,
        device_id   AS deviceId,
        value,
        temp,
        humi,
        battery,
        create_time AS createTime
        FROM tb_device_data
        WHERE device_id = #{deviceId}
        ORDER BY id DESC
    </select>

    <!-- 某设备最近 N 条数据，用于画图 -->
    <select id="selectLatestHistory"
            parameterType="map"
            resultType="com.example.data.dto.DataRecord">

        SELECT
        DATE_FORMAT(create_time, '%H:%i:%s') AS time,
        value
        FROM tb_device_data
        WHERE device_id = #{deviceId}
        ORDER BY create_time DESC
        LIMIT #{limit}

    </select>

    <select id="selectTimeoutOnlineDeviceIds" resultType="java.lang.Long">
        SELECT d.id
        FROM tb_device d
        LEFT JOIN (
        SELECT device_id, MAX(create_time) AS last_time
        FROM tb_device_data
        GROUP BY device_id
        ) t ON d.id = t.device_id
        WHERE d.status = 1
        AND (t.last_time IS NULL OR t.last_time &lt; #{cutoffTime})
    </select>

    <select id="countDevices" resultType="java.lang.Long">
        SELECT COUNT(*) FROM tb_device
    </select>

    <select id="selectDevicePage" resultType="com.example.data.dto.DeviceRowDTO">
        SELECT
        d.id AS id,
        d.status AS status,
        d.device_name AS deviceName,
        d.model AS model,
        d.location AS location,
        DATE_FORMAT(t.last_time, '%Y-%m-%d %H:%i:%s') AS lastReportTime,
        IFNULL(r.today_cnt, 0) AS todayReports
        FROM tb_device d
        LEFT JOIN (
        SELECT device_id, MAX(create_time) AS last_time
        FROM tb_device_data
        GROUP BY device_id
        ) t ON d.id = t.device_id
        LEFT JOIN (
        SELECT device_id, COUNT(*) AS today_cnt
        FROM tb_device_data
        WHERE DATE(create_time) = CURDATE()
        GROUP BY device_id
        ) r ON d.id = r.device_id
        ORDER BY d.id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>


    <select id="selectDeviceDetail" resultType="com.example.data.dto.DeviceDetailDTO">
        SELECT
        d.id AS id,
        d.status AS status,
        d.device_name AS deviceName,
        d.type AS type,
        d.model AS model,
        d.location AS location,
        DATE_FORMAT(t.last_time, '%Y-%m-%d %H:%i:%s') AS lastReportTime,
        IFNULL(r.today_cnt, 0) AS todayReports
        FROM tb_device d
        LEFT JOIN (
        SELECT device_id, MAX(create_time) AS last_time
        FROM tb_device_data
        GROUP BY device_id
        ) t ON d.id = t.device_id
        LEFT JOIN (
        SELECT device_id, COUNT(*) AS today_cnt
        FROM tb_device_data
        WHERE DATE(create_time) = CURDATE()
        GROUP BY device_id
        ) r ON d.id = r.device_id
        WHERE d.id = #{id}
    </select>

    <select id="selectHistoryPoints" resultType="com.example.data.dto.DataPointDTO">
        SELECT
        DATE_FORMAT(create_time, '%Y-%m-%d %H:%i:%s') AS time,
        ${metricCol} AS value
        FROM tb_device_data
        WHERE device_id = #{deviceId}
        AND ${metricCol} IS NOT NULL
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <select id="selectHistoryPointsRange" resultType="com.example.data.dto.DataPointDTO">
        SELECT
        DATE_FORMAT(create_time, '%Y-%m-%d %H:%i:%s') AS time,
        ${metricCol} AS value
        FROM tb_device_data
        WHERE device_id = #{deviceId}
        AND create_time &gt;= #{from}
        AND create_time &lt;= #{to}
        AND ${metricCol} IS NOT NULL
        ORDER BY create_time ASC
    </select>

    <select id="selectAllHistory"
            resultType="com.example.data.pojo.DeviceData">
        SELECT
        id,
        device_id   AS deviceId,
        value,
        temp,
        humi,
        battery,
        create_time AS createTime
        FROM tb_device_data
        ORDER BY id DESC
        LIMIT #{limit}
    </select>


</mapper>