<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.device.mapper.DeviceMapper">

    <resultMap id="DeviceMap" type="com.example.device.pojo.Device">
        <id column="id" property="id"/>
        <result column="device_name" property="deviceName"/>
        <result column="type" property="type"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="user_id" property="userId"/>
        <result column="model" property="model"/>
        <result column="location" property="location"/>
    </resultMap>

    <resultMap id="DeviceRowMap" type="com.example.device.dto.DeviceRowDTO">
        <id column="id" property="id"/>
        <result column="device_name" property="deviceName"/>
        <result column="type" property="type"/>
        <result column="status" property="status"/>
        <result column="model" property="model"/>
        <result column="location" property="location"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 新建设备 -->
    <insert id="insert" parameterType="com.example.device.pojo.Device" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO tb_device
        (device_name, type, status, create_time, update_time, user_id, model, location)
        VALUES
        (#{deviceName}, #{type}, #{status}, NOW(), NOW(), #{userId}, #{model}, #{location})
    </insert>

    <!-- 查询全部 -->
    <select id="selectAll"
            resultType="com.example.device.pojo.Device">
        SELECT id,
        device_name,
        type,
        status,
        user_id AS userId,
        create_time AS createTime,
        update_time AS updateTime
        FROM tb_device
        ORDER BY id DESC
    </select>

    <!-- 按 id 查询 -->
    <select id="selectById"
            parameterType="long"
            resultType="com.example.device.pojo.Device">
        SELECT id,
        device_name,
        type,
        status,
        user_id AS userId,
        create_time AS createTime,
        update_time AS updateTime
        FROM tb_device
        WHERE id = #{id}
    </select>

    <!-- 更新设备 -->
    <update id="update" parameterType="com.example.device.pojo.Device">
        UPDATE tb_device
        <set>
            <if test="deviceName != null">device_name = #{deviceName},</if>
            <if test="type != null">type = #{type},</if>
            <if test="status != null">status = #{status},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="model != null">model = #{model},</if>
            <if test="location != null">location = #{location},</if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除设备 -->
    <delete id="deleteById"
            parameterType="long">
        DELETE FROM tb_device
        WHERE id = #{id}
    </delete>

    <update id="updateStatusById">
        UPDATE tb_device
        SET status = #{status},
        update_time = NOW()
        WHERE id = #{id}
    </update>

    <update id="updateStatusBatch">
        UPDATE tb_device
        SET status = #{status},
        update_time = NOW()
        WHERE status &lt;&gt; #{status}
        AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <sql id="Where">
        <where>
            <if test="keyword != null and keyword != ''">
                AND device_name LIKE CONCAT('%', #{keyword}, '%')
            </if>
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </sql>

    <select id="selectList" resultMap="DeviceRowMap">
        SELECT id, device_name, type, status, model, location, create_time, update_time
        FROM tb_device
        <include refid="Where"/>
        ORDER BY id DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="count" resultType="long">
        SELECT COUNT(1)
        FROM tb_device
        <include refid="Where"/>
    </select>

</mapper>